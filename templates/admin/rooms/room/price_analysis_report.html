{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'admin/css/changelists.css' %}">
  <style>
    .report-container {
      padding: 20px;
    }
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .report-title {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .report-filters {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }
    .filter-group {
      margin-bottom: 0;
    }
    .filter-label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .chart-container {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      height: 400px;
    }
    .chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-col {
      flex: 1;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      height: 400px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .data-table th {
      background-color: #43A047;
      color: white;
      padding: 12px;
      text-align: right;
    }
    .data-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .data-table tr:hover {
      background-color: #f1f1f1;
    }
    .summary-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-card {
      flex: 1;
      min-width: 200px;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .card-value {
      font-size: 24px;
      font-weight: bold;
      color: #43A047;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      background-color: #f8f9fa;
      border-radius: 5px;
      color: #666;
    }
    .btn-primary {
      background-color: #43A047;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary:hover {
      background-color: #388E3C;
    }
    .price-difference {
      font-weight: bold;
    }
    .price-higher {
      color: #D32F2F;
    }
    .price-lower {
      color: #388E3C;
    }
    .price-equal {
      color: #FFA000;
    }
    .market-position {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin-top: 10px;
      position: relative;
    }
    .position-marker {
      position: absolute;
      top: -10px;
      width: 20px;
      height: 20px;
      background-color: #43A047;
      border-radius: 50%;
      transform: translateX(-50%);
    }
    .position-label {
      position: absolute;
      top: 15px;
      transform: translateX(-50%);
      font-size: 12px;
      color: #666;
    }
    .min-marker, .max-marker {
      position: absolute;
      top: 5px;
      font-size: 12px;
      color: #666;
    }
    .min-marker {
      left: 0;
    }
    .max-marker {
      right: 0;
    }
  </style>
{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list report-container{% endblock %}

{% block content %}
<div id="content-main">
  <div class="report-header">
    <h1 class="report-title">{% trans "تقرير تحليل الأسعار" %}</h1>
  </div>

  <div class="report-filters">
    <form method="get" class="filter-form">
      <div class="filter-group">
        <label class="filter-label" for="id_hotel">{% trans "الفندق" %}</label>
        <select name="hotel_id" id="id_hotel" class="form-control">
          <option value="">{% trans "جميع الفنادق" %}</option>
          {% for hotel in hotels %}
            <option value="{{ hotel.id }}" {% if selected_hotel_id == hotel.id|stringformat:"i" %}selected{% endif %}>{{ hotel.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_category">{% trans "تصنيف الغرفة" %}</label>
        <select name="category_id" id="id_category" class="form-control">
          <option value="">{% trans "جميع التصنيفات" %}</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if selected_category_id == category.id|stringformat:"i" %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_room_type">{% trans "نوع الغرفة" %}</label>
        <select name="room_type_id" id="id_room_type" class="form-control">
          <option value="">{% trans "اختر نوع الغرفة" %}</option>
          {% for room_type in room_types %}
            <option value="{{ room_type.id }}" {% if selected_room_type.id == room_type.id %}selected{% endif %}>{{ room_type.name }} ({{ room_type.hotel.name }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_period">{% trans "الفترة الزمنية" %}</label>
        <select name="period" id="id_period" class="form-control">
          <option value="30" {% if period == '30' %}selected{% endif %}>{% trans "آخر 30 يوم" %}</option>
          <option value="60" {% if period == '60' %}selected{% endif %}>{% trans "آخر 60 يوم" %}</option>
          <option value="90" {% if period == '90' or not period %}selected{% endif %}>{% trans "آخر 90 يوم" %}</option>
          <option value="180" {% if period == '180' %}selected{% endif %}>{% trans "آخر 180 يوم" %}</option>
          <option value="365" {% if period == '365' %}selected{% endif %}>{% trans "آخر سنة" %}</option>
        </select>
      </div>

      <div class="filter-group">
        <button type="submit" class="btn-primary">{% trans "تطبيق الفلتر" %}</button>
      </div>

      {% if pdf_export_url and selected_room_type %}
      <div class="filter-group">
        <a href="{{ pdf_export_url }}?room_type_id={{ selected_room_type.id }}&period={{ period }}&hotel_id={{ selected_hotel_id }}&category_id={{ selected_category_id }}" class="btn-primary" style="background-color: #D32F2F;">
          {% trans "تصدير PDF" %}
        </a>
      </div>
      {% endif %}
    </form>
  </div>

  {% if selected_room_type %}
    <!-- Room Type Info -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-title">{% trans "الفندق" %}</div>
        <div class="card-value">{{ selected_room_type.hotel.name }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "نوع الغرفة" %}</div>
        <div class="card-value">{{ selected_room_type.name }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "السعر الحالي" %}</div>
        <div class="card-value">{{ selected_room_type.base_price }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "السعة" %}</div>
        <div class="card-value">{{ selected_room_type.default_capacity }} {% trans "أشخاص" %}</div>
      </div>
    </div>

    <!-- Market Position -->
    {% if price_statistics.market_min and price_statistics.market_max %}
    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h3>{% trans "موقع السعر في السوق" %}</h3>
      <div class="market-position">
        <div class="position-marker" style="left: {{ price_statistics.price_position }}%;"></div>
        <div class="position-label" style="left: {{ price_statistics.price_position }}%;">{{ selected_room_type.base_price }}</div>
        <div class="min-marker">{{ price_statistics.market_min|floatformat:2 }}</div>
        <div class="max-marker">{{ price_statistics.market_max|floatformat:2 }}</div>
      </div>
      <div style="margin-top: 30px; text-align: center;">
        <p>{% trans "متوسط أسعار السوق" %}: {{ price_statistics.market_avg|floatformat:2 }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Charts -->
    <div class="chart-row">
      <div class="chart-col">
        <h3 class="text-center">{% trans "تاريخ الأسعار" %}</h3>
        <canvas id="priceHistoryChart"></canvas>
      </div>
      <div class="chart-col">
        <h3 class="text-center">{% trans "مقارنة الأسعار مع المنافسين" %}</h3>
        <canvas id="competitorPricesChart"></canvas>
      </div>
    </div>

    <!-- Competitor Data Table -->
    <h3>{% trans "تفاصيل أسعار المنافسين" %}</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>{% trans "الفندق" %}</th>
          <th>{% trans "نوع الغرفة" %}</th>
          <th>{% trans "السعر" %}</th>
          <th>{% trans "الفرق" %}</th>
          <th>{% trans "نسبة الفرق" %}</th>
        </tr>
      </thead>
      <tbody>
        <!-- Current Room Type -->
        <tr>
          <td><strong>{{ selected_room_type.hotel.name }}</strong></td>
          <td><strong>{{ selected_room_type.name }}</strong></td>
          <td><strong>{{ selected_room_type.base_price }}</strong></td>
          <td>-</td>
          <td>-</td>
        </tr>

        <!-- Competitors -->
        {% for competitor in competitor_data %}
          <tr>
            <td>{{ competitor.hotel_name }}</td>
            <td>{{ competitor.room_type_name }}</td>
            <td>{{ competitor.price|floatformat:2 }}</td>
            <td>
              {% if competitor.price_difference > 0 %}
                <span class="price-difference price-higher">+{{ competitor.price_difference|floatformat:2 }}</span>
              {% elif competitor.price_difference < 0 %}
                <span class="price-difference price-lower">{{ competitor.price_difference|floatformat:2 }}</span>
              {% else %}
                <span class="price-difference price-equal">0.00</span>
              {% endif %}
            </td>
            <td>
              {% if competitor.price_difference_percent > 0 %}
                <span class="price-difference price-higher">+{{ competitor.price_difference_percent|floatformat:2 }}%</span>
              {% elif competitor.price_difference_percent < 0 %}
                <span class="price-difference price-lower">{{ competitor.price_difference_percent|floatformat:2 }}%</span>
              {% else %}
                <span class="price-difference price-equal">0.00%</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Price History Table -->
    <h3 style="margin-top: 30px;">{% trans "تاريخ الأسعار" %}</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>{% trans "التاريخ" %}</th>
          <th>{% trans "السعر" %}</th>
          <th>{% trans "نوع السعر" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for item in price_history %}
          <tr>
            <td>{{ item.date }}</td>
            <td>{{ item.price|floatformat:2 }}</td>
            <td>
              {% if item.is_special %}
                <span style="color: #D32F2F;">{% trans "عرض خاص" %}</span>
              {% else %}
                <span style="color: #388E3C;">{% trans "سعر عادي" %}</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="no-data">
      <h3>{% trans "لا توجد بيانات متاحة" %}</h3>
      <p>{% trans "يرجى اختيار نوع غرفة لعرض تحليل الأسعار" %}</p>
    </div>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% if selected_room_type %}
      // Price History Chart
      var historyDates = {{ history_dates|safe }};
      var historyPrices = {{ history_prices|safe }};

      var historyCtx = document.getElementById('priceHistoryChart').getContext('2d');
      var historyChart = new Chart(historyCtx, {
        type: 'line',
        data: {
          labels: historyDates,
          datasets: [{
            label: '{% trans "سعر الغرفة" %}',
            data: historyPrices,
            backgroundColor: 'rgba(67, 160, 71, 0.2)',
            borderColor: 'rgba(67, 160, 71, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(67, 160, 71, 1)',
            pointBorderColor: '#fff',
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxTicksLimit: 10,
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });

      // Competitor Prices Chart
      var competitorNames = {{ competitor_names|safe }};
      var competitorPrices = {{ competitor_prices|safe }};

      // Add current room type to the comparison
      competitorNames.unshift("{{ selected_room_type.name }}");
      competitorPrices.unshift({{ selected_room_type.base_price }});

      var competitorCtx = document.getElementById('competitorPricesChart').getContext('2d');
      var competitorChart = new Chart(competitorCtx, {
        type: 'bar',
        data: {
          labels: competitorNames,
          datasets: [{
            label: '{% trans "سعر الغرفة" %}',
            data: competitorPrices,
            backgroundColor: function(context) {
              // Highlight the current room type
              return context.dataIndex === 0 ? 'rgba(67, 160, 71, 0.8)' : 'rgba(33, 150, 243, 0.7)';
            },
            borderColor: function(context) {
              return context.dataIndex === 0 ? 'rgba(67, 160, 71, 1)' : 'rgba(33, 150, 243, 1)';
            },
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    {% endif %}
  });
</script>
{% endblock %}
