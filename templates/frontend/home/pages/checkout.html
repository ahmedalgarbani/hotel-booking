{% extends "frontend/layout/master.html" %}

{% block content %}

<!-- ================================
    START BREADCRUMB AREA
================================= -->
<section class="breadcrumb-area bread-bg-10">
  <div class="breadcrumb-wrap">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="breadcrumb-content text-center">
            <div class="section-heading">
              <h2 class="sec__title text-white">الدفع</h2>
            </div>
            <span class="arrow-blink">
              <i class="la la-arrow-down"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="bread-svg-box">
    <svg
      class="bread-svg"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 100 10"
      preserveAspectRatio="none"
    >
      <polygon points="100 0 50 10 0 0 0 10 100 10"></polygon>
    </svg>
  </div>
</section>
<!-- ================================
    END BREADCRUMB AREA
================================= -->

<!-- ================================
    START BOOKING AREA
================================= -->
<section class="booking-area padding-top-100px padding-bottom-70px">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="form-box">
          <div class="form-title-wrap">
            <h3 class="title">معلومات التحويل</h3>
          </div>
          <div class="form-content">
            {% if paymentsMethods %}
            <div class="section-tab check-mark-tab text-center pb-4">
              <ul
                class="nav nav-tabs justify-content-center"
                id="paymentTabs"
                role="tablist"
              >
                {% for paymentsMethod in paymentsMethods %}
                <li class="nav-item">
                  <a
                    class="nav-link {% if forloop.first %}active{% endif %}"
                    id="tab-{{ paymentsMethod.id }}"
                    data-bs-toggle="tab"
                    href="#content-{{ paymentsMethod.id }}"
                    role="tab"
                    aria-controls="content-{{ paymentsMethod.id }}"
                    aria-selected="{{ forloop.first }}"
                  >
                    <i class="la la-check icon-element"></i>
                    <img
                      src="{{ paymentsMethod.payment_option.logo.url }}"
                      width="100"
                      height="80"
                      alt="{{ paymentsMethod.payment_option.method_name }}"
                    />
                    <span class="d-block pt-2">
                      {{ paymentsMethod.payment_option.method_name }}
                    </span>
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>

            <div class="tab-content">
              {% for method in paymentsMethods %}
              <div
                class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                id="content-{{ method.id }}"
                role="tabpanel"
                aria-labelledby="tab-{{ method.id }}"
              >
                <div class="payment-details mb-3">
                  <p class="mb-1"><strong>اسم الحساب:</strong> {{ method.account_name }}</p>
                  <p class="mb-1"><strong>رقم الحساب:</strong> {{ method.account_number }}</p>
                  <p class="mb-1"><strong>رقم الآيبان:</strong> {{ method.iban }}</p>
                  <p class="mb-0"><strong>تعليمات الدفع:</strong> {{ method.description }}</p>
                </div>
                <div class="contact-form-action">
                  {% if is_direct_booking %}
                  <form action="{% url 'payments:hotel_confirm_payment' hotel.id %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="room_id" value="{{ booking_data.room_id }}">
                    <input type="hidden" name="check_in_date" value="{{ booking_data.check_in_date }}">
                    <input type="hidden" name="check_out_date" value="{{ booking_data.check_out_date }}">
                    <input type="hidden" name="room_number" value="{{ booking_data.room_number }}">
                    <input type="hidden" name="adult_number" value="{{ booking_data.adult_number }}">
                    <input type="hidden" name="payment_method" value="{{ method.id }}">
                    <input type="hidden" name="total_price" value="{{ booking_data.total_price }}">
                    {% if booking_data.extra_services %}
                    {% for service_id in booking_data.extra_services %}
                    <input type="hidden" name="extra_services" value="{{ service_id }}">
                    {% endfor %}
                    {% endif %}
                    <button type="submit" class="theme-btn text-center w-100 mb-2">
                      <i class="la la-check-circle mr-2 font-size-18"></i>تأكيد الدفع
                    </button>
                  </form>
                  {% else %}
                  <form action="{% url 'payments:hotel_confirm_payment' hotel.id %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="payment_method" value="{{ method.id }}">
                    <button type="submit" class="theme-btn text-center w-100 mb-2">
                      <i class="la la-check-circle mr-2 font-size-18"></i>تأكيد الدفع
                    </button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-warning" role="alert">
              لا توجد طرق دفع متاحة لهذا الفندق.
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <!-- Booking Summary -->
        <div class="form-box booking-detail-form">
          <div class="form-title-wrap">
            <h3 class="title">ملخص الحجز</h3>
          </div>
          <div class="form-content">
            <div class="card-item shadow-none radius-none mb-0">
              {% if is_direct_booking %}
              <div class="card-body p-0">
                <div class="d-flex justify-content-between">
                  <div>
                    <h3 class="card-title">{{ room.name }}</h3>
                    <p class="card-meta">{{ hotel.name }}</p>
                  </div>
                </div>
                <div class="section-block"></div>
                <ul class="list-items list-items-2 py-3">
                  <li><span>تاريخ الدخول:</span>{{ booking_data.check_in_date }}</li>
                  <li><span>تاريخ الخروج:</span>{{ booking_data.check_out_date }}</li>
                  <li><span>عدد الغرف:</span>{{ booking_data.room_number }}</li>
                  <li><span>عدد الأشخاص:</span>{{ booking_data.adult_number }}</li>
                  {% if booking_data.extra_services %}
                  <li>
                    <span>الخدمات الإضافية:</span>
                    <ul>
                    {% for service in room.room_services.all %}
                      {% if service.id|stringformat:"s" in booking_data.extra_services %}
                      <li>{{ service.name }} - ${{ service.additional_fee }}</li>
                      {% endif %}
                    {% endfor %}
                    </ul>
                  </li>
                  {% endif %}
                </ul>
                <div class="section-block"></div>
                <ul class="list-items list-items-2 pt-3">
                  <li><span>السعر الإجمالي:</span>${{ booking_data.total_price }}</li>
                </ul>
              </div>
              {% else %}
              <div class="card-body p-0">
                <div class="d-flex justify-content-between">
                  <div>
                    <h3 class="card-title">{{ hotel.name }}</h3>
                  </div>
                </div>
                <div class="section-block"></div>
                {% for item in cart_items %}
                <div class="room-item mb-3">
                  <h4>{{ item.room_type.name }}</h4>
                  <ul class="list-items list-items-2 py-2">
                    <li><span>تاريخ الدخول:</span>{{ item.check_in_date|date:"Y-m-d" }}</li>
                    <li><span>تاريخ الخروج:</span>{{ item.check_out_date|date:"Y-m-d" }}</li>
                    <li><span>عدد الغرف:</span>{{ item.quantity }}</li>
                    <li><span>عدد الأشخاص:</span>{{ item.adult_number }}</li>
                    {% if item.shopping_services.exists %}
                    <li>
                      <span>الخدمات الإضافية:</span>
                      <ul>
                      {% for service in item.shopping_services.all %}
                        <li>{{ service.services.name }} - ${{ service.services.additional_fee }}</li>
                      {% endfor %}
                      </ul>
                    </li>
                    {% endif %}
                    <li><span>السعر:</span>${{ item.Total_price }}</li>
                  </ul>
                  <div class="section-block"></div>
                </div>
                {% endfor %}
                <ul class="list-items list-items-2 pt-3">
                  <li><span>السعر الإجمالي:</span>${{ total_price }}</li>
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock content %}
